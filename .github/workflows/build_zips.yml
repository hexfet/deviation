name: Build zips
on:
  push:
    branches: [ github_action_build ]

jobs:
  build:
    name: Build all zips
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-tags: true
      - name: Run Docker container
        uses: addnab/docker-run-action@v3
        with:
          image: deviationtx/deviation-docker
          options: -v ${{ github.workspace }}:/git/deviation
          run: |
            sudo /root/build.py --arm-prereq
            export PATH=$PATH:/opt/gcc-arm-none-eabi-8-2018-q4-major/bin
            cd /git/deviation/src
            make -j4 zips
      - name: Verify build
        id: zip_files
        shell: bash
        run: |
          num_zips=$(ls -l src/*zip | wc -l)
          echo "Found $num_zips zip files created"
          echo "num_zips=$num_zips" >> $GITHUB_OUTPUT
          if [[ $num_zips -eq 19 ]]; then
            echo "good_build=true" >> $GITHUB_OUTPUT
            mkdir -p build
            mv src/*zip build/
          else
            echo "good_build=false" >> $GITHUB_OUTPUT
            echo "Expected 19 zips - aborting"
            exit 1
          fi
      - name: Generate styled index.html
        run: |
          echo "<!DOCTYPE html>" > build/index.html
          echo "<html lang='en'><head><meta charset='utf-8'/>" >> build/index.html
          echo "<title>Downloads</title>" >> build/index.html
          echo "<style>
            body {
              font-family: system-ui, sans-serif;
              background-color: #f9fafb;
              color: #333;
              padding: 2rem;
              line-height: 1.6;
            }
            h1 {
              text-align: center;
              margin-bottom: 2rem;
              color: #222;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              background: white;
              border-radius: 12px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.08);
              overflow: hidden;
            }
            th, td {
              padding: 12px 16px;
              text-align: left;
            }
            th {
              background-color: #f3f4f6;
              font-weight: 600;
            }
            tr:nth-child(even) { background-color: #fafafa; }
            a {
              color: #0366d6;
              text-decoration: none;
            }
            a:hover {
              text-decoration: underline;
            }
          </style></head><body>" >> build/index.html

          echo "<h1>Available Builds</h1><table>" >> build/index.html
          echo "<tr><th>File</th><th>Size</th><th>Last Modified</th></tr>" >> build/index.html
          find build -type f -name '*.zip' | sort | while read file; do
            relpath=\"${file#build/}\"
            size=$(du -h "$file" | cut -f1)
            mtime=$(date -r "$file" "+%Y-%m-%d %H:%M")
            echo "<tr><td><a href=\"$relpath\">$relpath</a></td><td>$size</td><td>$mtime</td></tr>" >> build/index.html
          done
          echo "</table></body></html>" >> build/index.html

      - name: Upload zips as artifact
        if: ${{ steps.zip_files.outputs.good_build == 'true' }}
        id: deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4          

        
