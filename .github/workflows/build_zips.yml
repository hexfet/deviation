name: Build zips
on:
  push:
    branches: [ github_action_build ]

jobs:
  build_type0:
    name: Build all zips (BUILD_TYPE=0)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-tags: true
      - name: Run Docker container
        uses: addnab/docker-run-action@v3
        with:
          image: deviationtx/deviation-docker
          options: -v ${{ github.workspace }}:/git/deviation
          run: |
            sudo /root/build.py --arm-prereq
            export PATH=$PATH:/opt/gcc-arm-none-eabi-8-2018-q4-major/bin
            cd /git/deviation/src
            BUILD_TYPE=0 make -j4 zips
      - name: Verify build and collect zips
        id: zip_files
        shell: bash
        run: |
          mkdir -p build/type0
          num_zips=$(ls -1 src/*zip | wc -l || true)
          echo "Found $num_zips zip files created"
          if [[ $num_zips -eq 19 ]]; then
            mv src/*zip build/type0/
          else
            echo "Expected 19 zips - aborting"
            exit 1
          fi
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-type0
          path: build/type0/

  build_type1:
    name: Build all zips (BUILD_TYPE=1)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-tags: true
      - name: Run Docker container
        uses: addnab/docker-run-action@v3
        with:
          image: deviationtx/deviation-docker
          options: -v ${{ github.workspace }}:/git/deviation
          run: |
            sudo /root/build.py --arm-prereq
            export PATH=$PATH:/opt/gcc-arm-none-eabi-8-2018-q4-major/bin
            cd /git/deviation/src
            BUILD_TYPE=1 make -j4 zips
      - name: Verify build and collect zips
        id: zip_files
        shell: bash
        run: |
          mkdir -p build/type1
          num_zips=$(ls -1 src/*zip | wc -l || true)
          echo "Found $num_zips zip files created"
          if [[ $num_zips -eq 19 ]]; then
            mv src/*zip build/type1/
          else
            echo "Expected 19 zips - aborting"
            exit 1
          fi
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-type1
          path: build/type1/

  assemble:
    name: Assemble builds and upload pages artifact
    runs-on: ubuntu-latest
    needs: [build_type0, build_type1]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Download BUILD_TYPE=0 artifact
        uses: actions/download-artifact@v4
        with:
          name: build-type0
          path: build/type0
      - name: Download BUILD_TYPE=1 artifact
        uses: actions/download-artifact@v4
        with:
          name: build-type1
          path: build/type1
      - name: Generate styled index.html
        run: |
          echo "<!DOCTYPE html>" > build/index.html
          echo "<html lang='en'><head><meta charset='utf-8'/>" >> build/index.html
          echo "<title>Downloads</title>" >> build/index.html
          echo "<style>
            body {
              font-family: system-ui, sans-serif;
              background-color: #f9fafb;
              color: #333;
              padding: 2rem;
              line-height: 1.6;
            }
            h1 { text-align: left; margin-bottom: 2rem; color: #222; }
            h2 { margin-top: 1.5rem; color: #333; }
            table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); overflow: hidden; }
            th, td { padding: 12px 16px; text-align: left; }
            th { background-color: #f3f4f6; font-weight: 600; }
            tr:nth-child(even) { background-color: #fafafa; }
            a { color: #0366d6; text-decoration: none; }
            a:hover { text-decoration: underline; }
          </style></head><body>" >> build/index.html

          echo "<h1>Repo</h1>" >> build/index.html
          echo "<a src=\"https://github.com/hexfet/deviation\">Deviation@hexfet</a>" >> build/index.html
          echo "<h1>Available Builds</h1>" >> build/index.html
          echo "<h2>BUILD_TYPE=0 includes: LOLI, Propel, CRSF configuration</h2>" >> build/index.html
          echo "<table><tr><th>File</th><th>Size</th><th>Last Modified</th></tr>" >> build/index.html
          find build/type0 -type f -name '*.zip' | sort | while read file; do
            relpath="${file#build/}"
            size=$(du -h "$file" | cut -f1)
            mtime=$(date -r "$file" "+%Y-%m-%d %H:%M")
            echo "<tr><td><a href=\"$relpath\">$relpath</a></td><td>$size</td><td>$mtime</td></tr>" >> build/index.html
          done
          echo "</table>" >> build/index.html

          echo "<h2>BUILD_TYPE=1 includes: Bluesky, NE260, E016H</h2>" >> build/index.html
          echo "<table><tr><th>File</th><th>Size</th><th>Last Modified</th></tr>" >> build/index.html
          find build/type1 -type f -name '*.zip' | sort | while read file; do
            relpath="${file#build/}"
            size=$(du -h "$file" | cut -f1)
            mtime=$(date -r "$file" "+%Y-%m-%d %H:%M")
            echo "<tr><td><a href=\"$relpath\">$relpath</a></td><td>$size</td><td>$mtime</td></tr>" >> build/index.html
          done
          echo "</table></body></html>" >> build/index.html

      - name: Upload zips as artifact
        id: deployment
        uses: actions/upload-pages-artifact@v4
        with:
          path: build/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: assemble
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

        
