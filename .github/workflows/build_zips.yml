name: Build zips
on:
  push:
    branches: [ github_action_build ]

jobs:
  build:
    name: Build all zips
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-tags: true
      - name: Run Docker container
        uses: addnab/docker-run-action@v3
        with:
          image: deviationtx/deviation-docker
          options: -v ${{ github.workspace }}:/git/deviation
          run: |
            sudo /root/build.py --arm-prereq
            export PATH=$PATH:/opt/gcc-arm-none-eabi-8-2018-q4-major/bin
            cd /git/deviation/src
            make zips
      - name: Verify build
        id: zip_files
        shell: bash
        run: |
          num_zips=$(ls -l src/*zip | wc -l)
          echo "Found $num_zips zip files created"
          echo "num_zips=$num_zips" >> $GITHUB_OUTPUT
          if [[ $num_zips -eq 19 ]]; then
            echo "good_build=true" >> $GITHUB_OUTPUT
            mkdir -p build
            mv src/*zip build/
          else
            echo "good_build=false" >> $GITHUB_OUTPUT
            echo "Expected 19 zips - aborting"
            exit 1
          fi
      - name: Generate index.html
        run: |
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Downloads</title></head><body><h1>Available Builds</h1><ul>" > build/index.html
          find build -type f -name '*.zip' | sort | while read file; do
            relpath="${file#build/}"
            echo "<li><a href=\"$relpath\">$relpath</a></li>" >> build/index.html
          done
          echo "</ul></body></html>" >> build/index.html          
      - name: Upload zips as artifact
        if: ${{ steps.zip_files.outputs.good_build == 'true' }}
        id: deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4          

        
